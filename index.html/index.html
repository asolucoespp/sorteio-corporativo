<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Sorteio FlyTour</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#0f1115;
  --card:#171a21;
  --text:#ffffff;
  --muted:#9aa0a6;
  --accent:#2563eb;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  font-family: Inter, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

.wrap{
  max-width:1200px;
  margin:20px auto;
  background:var(--card);
  border-radius:16px;
  padding:24px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.logos{
  display:flex;
  gap:16px;
  align-items:center;
}
.logos img{
  height:36px;
  object-fit:contain;
}

/* ROLETA */
.roleta-area{
  display:flex;
  gap:40px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}

canvas{
  background:#0b0e14;
  border-radius:50%;
}

/* CONTROLES */
.controls{
  display:flex;
  flex-direction:column;
  gap:12px;
  min-width:300px;
}

select,button,textarea{
  padding:14px;
  border-radius:10px;
  border:none;
  font-size:14px;
}

select,textarea{
  background:#0b1220;
  color:#fff;
}

button{
  background:var(--accent);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

button.secondary{ background:#1f2937; }
button.danger{ background:#7f1d1d; }

/* RESULTADO */
#resultado{
  font-size:32px;
  font-weight:800;
  text-align:center;
  margin:28px 0;
}

/* GANHADORES */
.winner{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.06);
  display:flex;
  justify-content:space-between;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-content{
  background:#171a21;
  padding:24px;
  border-radius:14px;
  width:95%;
  max-width:760px;
}

.modal-content label{
  display:block;
  margin-top:14px;
  font-size:13px;
  color:var(--muted);
}

.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:12px;
  margin-top:20px;
}
</style>
</head>

<body>

<div class="wrap">

  <div class="header">
    <div class="logos">
      <!-- AJUSTE O CAMINHO SE NECESSÃRIO -->
      <img src="./assets/accor.png" alt="Accor">
      <img src="./assets/aircanada.png" alt="Air Canada">
      <img src="./assets/avianca.png" alt="Avianca">
      <img src="./assets/flytour.png" alt="Flytour">
    </div>
    <strong>Sorteio Corporativo</strong>
  </div>

  <div class="roleta-area">
    <canvas id="wheel" width="560" height="560"></canvas>

    <div class="controls">
      <select id="selectItem"></select>
      <button id="btnGirar">Girar roleta</button>

      <button id="btnConfig" class="secondary">âš™ Configurar</button>
      <button id="btnReset" class="danger">ðŸ”„ Resetar sorteio</button>
      <button id="btnExport" class="secondary">ðŸ’¾ Exportar CSV</button>
    </div>
  </div>

  <div id="resultado">Aguardando sorteio</div>
  <div id="winners"></div>
</div>

<!-- MODAL CONFIG -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>ConfiguraÃ§Ã£o</h3>

    <label>Participantes (1 por linha)</label>
    <textarea id="cfgNames" rows="6"></textarea>

    <label>Itens (Item;Quantidade)</label>
    <textarea id="cfgItems" rows="5"></textarea>

    <div class="modal-actions">
      <button onclick="closeModal()" class="secondary">Cancelar</button>
      <button onclick="saveConfig()">Salvar</button>
    </div>
  </div>
</div>

<script>
/* ================= ESTADO ================= */
let baseParticipantes = JSON.parse(localStorage.getItem("baseParticipants")) || [];
let participantes = JSON.parse(localStorage.getItem("participants")) || [];
let itens = JSON.parse(localStorage.getItem("items")) || [];
let vencedores = JSON.parse(localStorage.getItem("winners")) || [];

/* ================= CANVAS ================= */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const center = canvas.width / 2;
const radius = center - 20;

let anguloAtual = 0;
const cores = ["#2563eb","#9333ea","#16a34a","#ea580c","#dc2626","#0d9488"];

/* ================= ROLETA ================= */
function desenharRoleta(){
  const total = participantes.length || 1;
  const ang = (2*Math.PI)/total;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  participantes.forEach((nome,i)=>{
    ctx.beginPath();
    ctx.fillStyle = cores[i % cores.length];
    ctx.moveTo(center, center);
    ctx.arc(center, center, radius, i*ang, (i+1)*ang);
    ctx.fill();

    ctx.save();
    ctx.translate(center, center);
    ctx.rotate(i*ang + ang/2);
    ctx.fillStyle="#fff";
    ctx.font="bold 18px Arial";
    ctx.fillText(nome, radius * 0.55, 6);
    ctx.restore();
  });
}

function desenharPonteiro(){
  ctx.fillStyle="#fff";
  ctx.beginPath();
  ctx.moveTo(center, 10);
  ctx.lineTo(center - 14, 40);
  ctx.lineTo(center + 14, 40);
  ctx.closePath();
  ctx.fill();
}

/* ================= ITENS ================= */
const selectItem = document.getElementById("selectItem");

function renderSelectItems(){
  selectItem.innerHTML = "";
  itens.forEach((it,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${it.nome} (${it.qtd})`;
    if(it.qtd === 0) opt.disabled = true;
    selectItem.appendChild(opt);
  });
}

/* ================= SORTEIO ================= */
document.getElementById("btnGirar").onclick = ()=>{
  if(!participantes.length || !itens.length){
    alert("Configure o sorteio");
    return;
  }

  const item = itens[selectItem.value];
  if(item.qtd === 0) return;

  const DURATION = 3000;
  const MIN_SPINS = 5;

  const inicio = anguloAtual;
  const fim = inicio + (MIN_SPINS*360) + Math.random()*360;
  let start = null;

  function animar(ts){
    if(!start) start = ts;
    const p = Math.min((ts-start)/DURATION,1);
    const ease = 1 - Math.pow(1-p,3);

    anguloAtual = inicio + (fim-inicio)*ease;

    ctx.save();
    ctx.translate(center, center);
    ctx.rotate(anguloAtual * Math.PI / 180);
    ctx.translate(-center, -center);
    desenharRoleta();
    ctx.restore();

    desenharPonteiro();

    if(p < 1){
      requestAnimationFrame(animar);
    } else {
      finalizar(item);
    }
  }

  requestAnimationFrame(animar);
};

function finalizar(item){
  const ang = (anguloAtual % 360 + 360) % 360;
  const idx = Math.floor((360 - ang) / (360 / participantes.length));
  const nome = participantes.splice(idx,1)[0];

  item.qtd--;

  vencedores.push({
    nome,
    item: item.nome,
    data: new Date().toLocaleString("pt-BR")
  });

  document.getElementById("resultado").textContent = nome;

  saveState();
  renderSelectItems();
  renderWinners();
  desenharRoleta();
  desenharPonteiro();
}

/* ================= CONFIG ================= */
document.getElementById("btnConfig").onclick = ()=>{
  cfgNames.value = baseParticipantes.join("\n");
  cfgItems.value = itens.map(i=>`${i.nome};${i.qtd}`).join("\n");
  modal.style.display="flex";
};

function saveConfig(){
  baseParticipantes = cfgNames.value.split("\n").map(v=>v.trim()).filter(Boolean);
  participantes = [...baseParticipantes];

  itens = cfgItems.value.split("\n").map(l=>{
    const [nome,qtd] = l.split(";");
    return { nome:nome.trim(), qtd:Number(qtd)||0 };
  });

  vencedores = [];
  saveState();

  renderSelectItems();
  renderWinners();
  desenharRoleta();
  desenharPonteiro();
  closeModal();
}

/* ================= RESET ================= */
document.getElementById("btnReset").onclick = ()=>{
  if(confirm("Deseja limpar apenas os ganhadores?")){
    vencedores = [];
    participantes = [...baseParticipantes];
    saveState();
    renderWinners();
    renderSelectItems();
    desenharRoleta();
    desenharPonteiro();
    document.getElementById("resultado").textContent = "Sorteio resetado";
  }
};

/* ================= UTIL ================= */
function renderWinners(){
  const div = document.getElementById("winners");
  div.innerHTML = vencedores.map(v=>
    `<div class="winner"><span>${v.nome}</span><span>${v.item}</span></div>`
  ).join("");
}

function saveState(){
  localStorage.setItem("baseParticipants",JSON.stringify(baseParticipantes));
  localStorage.setItem("participants",JSON.stringify(participantes));
  localStorage.setItem("items",JSON.stringify(itens));
  localStorage.setItem("winners",JSON.stringify(vencedores));
}

function closeModal(){
  modal.style.display="none";
}

/* ================= EXPORT ================= */
document.getElementById("btnExport").onclick = ()=>{
  const csv = ["Nome,Item,Data"].concat(
    vencedores.map(v=>`${v.nome},${v.item},${v.data}`)
  ).join("\n");

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download = "sorteio.csv";
  a.click();
};

/* INIT */
renderSelectItems();
desenharRoleta();
desenharPonteiro();
renderWinners();
</script>

</body>
</html>
